<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BuddyAdmin</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --panel2:#fff7f0;
      --text:#0f172a;
      --muted:#64748b;
      --orange:#ff7a00;
      --stroke: rgba(15,23,42,.12);
      --shadow: 0 18px 45px rgba(15,23,42,.10);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(255,122,0,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(255,122,0,.10), transparent 60%),
        var(--bg);
      color: var(--text);
      min-height:100vh;
      display:flex;
      align-items:stretch;
    }

    .shell{
      width: min(1100px, 94vw);
      margin: 26px auto;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap: 18px;
      align-items:start;
    }

    .panel{
      border-radius: var(--radius);
      background: var(--panel);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .brand{
      padding:18px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, rgba(255,122,0,.08), transparent 55%);
      border-bottom: 1px solid rgba(15,23,42,.06);
    }

    .logo{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }

    .logoImg{
      width:46px; height:46px;
      border-radius: 16px;
      object-fit: cover;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 12px 26px rgba(255,122,0,.18);
      background:#fff;
      flex: 0 0 auto;
    }

    .brand h1{
      margin:0;
      font-size:16px;
      font-weight:900;
      letter-spacing:.2px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .tagline{
      margin-top:4px;
      font-size:12px;
      color: var(--muted);
      line-height:1.2;
    }

    .badge{
      font-family: var(--mono);
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,122,0,.10);
      border:1px solid rgba(255,122,0,.22);
      color: rgba(15,23,42,.85);
      flex: 0 0 auto;
    }

    .sidebar .inner{ padding: 12px 12px 14px; }
    .sidebar .card{
      background: #ffffff;
      border:1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding: 14px;
      margin: 10px 0;
      box-shadow: 0 12px 24px rgba(15,23,42,.06);
    }

    .label{ font-size:12px; color: var(--muted); margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.14);
      background: #ffffff;
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    input::placeholder, textarea::placeholder{ color: rgba(100,116,139,.75); }
    textarea{ min-height: 90px; resize: vertical; }

    .btn{
      border: none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      font-size: 14px;
      color: #ffffff;
      background: var(--orange);
      box-shadow: 0 14px 28px rgba(255,122,0,.20);
      transition: transform .08s ease, filter .2s ease;
      width:100%;
    }
    .btn:hover{ filter: brightness(1.03); }
    .btn:active{ transform: translateY(1px); }

    .btn.secondary{
      background: #ffffff;
      color: var(--text);
      border:1px solid rgba(15,23,42,.14);
      box-shadow:none;
      font-weight:800;
    }

    .content{ padding: 14px; }

    .content .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px 14px 6px;
    }

    .userline{
      display:flex; flex-direction:column; gap:3px;
      min-width:0;
    }
    .userline .name{
      font-size:16px; font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .userline .meta{
      font-size:12px; color: var(--muted);
      font-family: var(--mono);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      padding: 10px 14px 14px;
    }

    .kpi{
      background: var(--panel2);
      border:1px solid rgba(255,122,0,.18);
      border-radius: 18px;
      padding: 14px;
      min-height: 92px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .kpi .t{ font-size:12px; color: rgba(15,23,42,.70); }
    .kpi .v{ font-size:28px; font-weight:950; letter-spacing:.2px; }
    .kpi .s{ font-size:12px; color: rgba(15,23,42,.70); }

    .section{ padding: 0 14px 14px; }
    .section h2{
      font-size:13px;
      letter-spacing:.12em;
      text-transform: uppercase;
      margin: 10px 0 10px;
      color: rgba(15,23,42,.72);
    }

    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.12);
      background: #ffffff;
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(15,23,42,.10);
      font-size: 13px;
      color: rgba(15,23,42,.92);
      vertical-align: top;
    }
    .table th{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing:.1em;
      color: rgba(15,23,42,.68);
      background: rgba(255,122,0,.06);
    }
    .table tr:last-child td{ border-bottom:none; }

    .pill{
      display:inline-block;
      padding: 4px 10px;
      border-radius:999px;
      font-size: 12px;
      font-family: var(--mono);
      border:1px solid rgba(15,23,42,.14);
      background: rgba(15,23,42,.04);
    }
    .pill.orange{ background: rgba(255,122,0,.12); border-color: rgba(255,122,0,.22); }
    .pill.green{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.22); }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .toast{
      position: fixed;
      right: 16px; bottom: 16px;
      background: rgba(15,23,42,.92);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      max-width: min(420px, 92vw);
      display:none;
      z-index: 999;
    }
    .toast.show{ display:block; }

    @media (max-width: 900px){
      body{ align-items:flex-start; }
      .shell{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- SIDEBAR -->
    <div class="panel sidebar">
      <div class="brand">
        <div class="logo">
          <!-- Put your logo file in the SAME folder as this HTML and name it: buddy-learning-logo.png -->
          <img class="logoImg" src="buddy-learning-logo.png" alt="Buddy Learning Logo" />
          <div style="min-width:0">
            <h1>Buddy Learning</h1>
            <div class="tagline">Your Buddy in Education</div>
          </div>
        </div>
        <div class="badge" id="envBadge">BUDDYADMIN</div>
      </div>

      <div class="inner">
        <div class="card" id="loginCard">
          <div class="label">Unique Code</div>
          <input id="codeInput" placeholder="e.g. A1001 / T2001 / L3001" autocomplete="off" />
          <div style="height:10px"></div>
          <button class="btn" id="loginBtn">Login</button>
          <div style="margin-top:10px;font-size:12px;color:var(--muted);line-height:1.35">
            Use your unique Admin, Tutor, or Learner code.
          </div>
        </div>

        <div class="card" id="sessionCard" style="display:none">
          <div class="label">Signed in as</div>
          <div style="font-weight:950;font-size:15px" id="who"></div>
          <div style="font-family:var(--mono);font-size:12px;color:var(--muted)" id="whoMeta"></div>
          <div style="height:10px"></div>
          <button class="btn secondary" id="logoutBtn">Logout</button>
        </div>

        <div class="card" id="actionsCard" style="display:none">
          <div class="label">Quick Actions</div>
          <div id="quickActions"></div>
        </div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="panel content">
      <div class="topbar">
        <div class="userline">
          <div class="name" id="pageTitle">Welcome</div>
          <div class="meta" id="pageSubtitle">Login to manage lessons, purchases, and invoices.</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <select id="monthSelect" style="max-width:160px; display:none"></select>
        </div>
      </div>

      <div class="grid" id="kpis" style="display:none"></div>

      <div class="section" id="mainSection" style="display:none">
        <h2 id="sectionTitle">Overview</h2>
        <div id="sectionBody"></div>
      </div>

      <div style="padding:14px;color:var(--muted);line-height:1.45" id="emptyState">
        <div style="font-size:14px;font-weight:950;color:var(--text);margin-bottom:6px">Buddy Learning Lesson Tracking</div>
        <div>
          This portal lets <span class="pill orange">Admins</span> assign lessons and record purchases,
          <span class="pill orange">Learners</span> track lessons paid/done/left,
          and <span class="pill orange">Tutors</span> mark lessons completed and generate monthly invoices.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  /********************
   * CONFIG
   ********************/
  const SCRIPT_URL = "PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE"; // <-- replace

  /********************
   * STATE
   ********************/
  let session = {
    session_code: null,
    user: null,
  };

  const $ = (id) => document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2600);
  }

  function yyyymm(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  }

  function fillMonthSelect(){
    const sel = $("monthSelect");
    sel.innerHTML = "";
    const now = new Date();
    for(let i=0;i<18;i++){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const v = yyyymm(d);
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    }
    sel.value = yyyymm(now);
  }

  async function api(action, payload={}){
    if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_YOUR")) {
      throw new Error("Set SCRIPT_URL in the HTML (top of the script).");
    }
    const body = { action, ...payload };
    if (action !== "login") body.session_code = session.session_code;

    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Request failed");
    return data;
  }

  /********************
   * PAY CALC (Greedy: 10-pack then 4-pack then singles)
   * Example:
   * 6 -> 4-pack + 2 singles
   * 16 -> 10-pack + 4-pack + 2 singles
   ********************/
  function calcTutorInvoice(lessonsDoneThisMonth){
    const n = Math.max(0, Number(lessonsDoneThisMonth) || 0);

    const packs10 = Math.floor(n / 10);
    let rem = n % 10;

    const packs4 = Math.floor(rem / 4);
    rem = rem % 4;

    const singles = rem;

    const total = (packs10 * 1700) + (packs4 * 660) + (singles * 175);

    const parts = [];
    if (packs10) parts.push({ label: "10-session package", qty: packs10, amount: packs10 * 1700 });
    if (packs4) parts.push({ label: "4-session package", qty: packs4, amount: packs4 * 660 });
    if (singles) parts.push({ label: "Single sessions", qty: singles, amount: singles * 175 });

    return { n, packs10, packs4, singles, total, parts };
  }

  function getInvoiceDates(targetYYYYMM){
    const [yStr, mStr] = String(targetYYYYMM).split("-");
    const y = Number(yStr);
    const m = Number(mStr); // 1-12

    const due = new Date(y, m-1, 28);        // 28th
    const paid = new Date(y, m, 0);          // last day of month (day 0 of next month)
    const fmt = (d) => d.toISOString().slice(0,10);
    return { due: fmt(due), paid: fmt(paid) };
  }

  function setSessionUI(signedIn){
    $("loginCard").style.display = signedIn ? "none" : "block";
    $("sessionCard").style.display = signedIn ? "block" : "none";
    $("actionsCard").style.display = signedIn ? "block" : "none";
    $("kpis").style.display = signedIn ? "grid" : "none";
    $("mainSection").style.display = signedIn ? "block" : "none";
    $("emptyState").style.display = signedIn ? "none" : "block";
    $("monthSelect").style.display = (signedIn && session.user?.role === "tutor") ? "block" : "none";
  }

  function setHeader(title, subtitle){
    $("pageTitle").textContent = title;
    $("pageSubtitle").textContent = subtitle;
  }

  function renderKPIs(items){
    const wrap = $("kpis");
    wrap.innerHTML = "";
    items.forEach(k => {
      const div = document.createElement("div");
      div.className = "kpi";
      div.innerHTML = `
        <div class="t">${k.label}</div>
        <div class="v">${k.value}</div>
        <div class="s">${k.sub || ""}</div>
      `;
      wrap.appendChild(div);
    });
  }

  function table(headers, rows){
    const th = headers.map(h=>`<th>${h}</th>`).join("");
    const tr = rows.map(r => `<tr>${r.map(c=>`<td>${c ?? ""}</td>`).join("")}</tr>`).join("");
    return `<table class="table"><thead><tr>${th}</tr></thead><tbody>${tr || `<tr><td colspan="${headers.length}">No data</td></tr>`}</tbody></table>`;
  }

  function money(n){
    const v = Number(n)||0;
    return "R" + v.toLocaleString("en-ZA");
  }

  function suggestAmount(lessons){
    const L = Number(lessons)||0;
    if (L === 4) return 660;
    if (L === 10) return 1700;
    return L * 175;
  }

  function renderQuickActions(){
    const q = $("quickActions");
    const role = session.user.role;

    if (role === "learner"){
      q.innerHTML = `<div style="font-size:12px;color:var(--muted);line-height:1.35">
        Learners can view progress only.
      </div>`;
      return;
    }

    if (role === "tutor"){
      q.innerHTML = `<div style="font-size:12px;color:var(--muted);line-height:1.35">
        Tutors can mark their assigned lessons as <span class="pill green">DONE</span>.
      </div>`;
      return;
    }

    // admin
    q.innerHTML = `
      <button class="btn secondary" id="refreshBtn">Refresh Summary</button>
      <div style="height:8px"></div>
      <div style="font-size:12px;color:var(--muted);line-height:1.35">
        Admin can record purchases, create lessons and assign tutors.
      </div>
    `;
    setTimeout(()=>{
      const b = $("refreshBtn");
      if (b) b.onclick = () => loadRoleHome();
    },0);
  }

  async function loadRoleHome(){
    const u = session.user;
    renderQuickActions();

    if (u.role === "admin"){
      setHeader(`Admin Dashboard`, `Record purchases, create lessons, assign tutors.`);
      const sum = await api("adminSummary");

      renderKPIs([
        { label:"Lessons Bought (Total)", value: sum.totals.lessonsBought, sub:"All purchases" },
        { label:"Lessons Done (Total)", value: sum.totals.lessonsDone, sub:"Completed lessons" },
        { label:"Lessons Assigned", value: sum.totals.lessonsAssigned, sub:"Pending completion" },
      ]);

      $("sectionTitle").textContent = "Admin Tools";

      $("sectionBody").innerHTML = `
        <div class="row" style="margin-bottom:12px">
          <div class="panel" style="padding:12px;background:#fff;border:1px solid rgba(15,23,42,.10);border-radius:18px;box-shadow:0 12px 24px rgba(15,23,42,.06)">
            <h3 style="margin:0 0 10px;font-size:14px">Add Purchase</h3>
            <div class="label">Learner Code</div>
            <input id="pLearner" placeholder="e.g. L3001" />
            <div class="row">
              <div>
                <div class="label">Lessons Bought</div>
                <input id="pLessons" type="number" placeholder="e.g. 10" />
              </div>
              <div>
                <div class="label">Amount Paid (auto-suggest)</div>
                <input id="pAmount" type="number" placeholder="e.g. 1700" />
              </div>
            </div>
            <div class="label" style="margin-top:8px">Purchase Date</div>
            <input id="pDate" type="date" />
            <div style="height:10px"></div>
            <button class="btn" id="addPurchaseBtn">Save Purchase</button>
            <div style="margin-top:8px;font-size:12px;color:var(--muted)">
              Pricing guide: 1 lesson R175 • 4 lessons R660 • 10 lessons R1700
            </div>
          </div>

          <div class="panel" style="padding:12px;background:#fff;border:1px solid rgba(15,23,42,.10);border-radius:18px;box-shadow:0 12px 24px rgba(15,23,42,.06)">
            <h3 style="margin:0 0 10px;font-size:14px">Create Lesson</h3>
            <div class="label">Learner Code</div>
            <input id="lLearner" placeholder="e.g. L3001" />
            <div class="row">
              <div>
                <div class="label">Lesson Date</div>
                <input id="lDate" type="date" />
              </div>
              <div>
                <div class="label">Minutes</div>
                <input id="lMinutes" type="number" placeholder="60" />
              </div>
            </div>
            <div class="label" style="margin-top:8px">Notes</div>
            <textarea id="lNotes" placeholder="Topic / outcomes..."></textarea>
            <button class="btn" id="createLessonBtn">Create Lesson</button>
          </div>
        </div>

        <div class="panel" style="padding:12px;background:#fff;border:1px solid rgba(15,23,42,.10);border-radius:18px;box-shadow:0 12px 24px rgba(15,23,42,.06)">
          <h3 style="margin:0 0 10px;font-size:14px">Assign Lesson to Tutor</h3>
          <div class="row">
            <div>
              <div class="label">Lesson ID</div>
              <input id="aLessonId" placeholder="e.g. L1700000000000" />
            </div>
            <div>
              <div class="label">Tutor Code</div>
              <input id="aTutor" placeholder="e.g. T2001" />
            </div>
          </div>
          <div style="height:10px"></div>
          <button class="btn" id="assignBtn">Assign</button>
        </div>
      `;

      setTimeout(()=>{
        const pLessons = $("pLessons");
        const pAmount = $("pAmount");
        const pDate = $("pDate");
        const lDate = $("lDate");

        const today = new Date();
        pDate.valueAsDate = today;
        lDate.valueAsDate = today;

        pLessons.oninput = () => { pAmount.value = suggestAmount(pLessons.value); };

        $("addPurchaseBtn").onclick = async () => {
          const learner_code = $("pLearner").value.trim();
          const lessons_bought = Number($("pLessons").value);
          const amount_paid = Number($("pAmount").value);
          const purchase_date = $("pDate").value;

          if (!learner_code || !lessons_bought) return toast("Enter learner code + lessons bought.");
          const r = await api("adminAddPurchase", { learner_code, lessons_bought, amount_paid, purchase_date });
          toast(`Purchase saved (${r.purchase_id}).`);
          loadRoleHome();
        };

        $("createLessonBtn").onclick = async () => {
          const learner_code = $("lLearner").value.trim();
          const lesson_date = $("lDate").value;
          const minutes = Number($("lMinutes").value || 60);
          const notes = $("lNotes").value || "";

          if (!learner_code) return toast("Enter learner code.");
          const r = await api("adminCreateLesson", { learner_code, lesson_date, minutes, notes });
          toast(`Lesson created (${r.lesson_id}).`);
        };

        $("assignBtn").onclick = async () => {
          const lesson_id = $("aLessonId").value.trim();
          const tutor_code = $("aTutor").value.trim();
          if (!lesson_id || !tutor_code) return toast("Enter lesson ID + tutor code.");
          await api("adminAssignLesson", { lesson_id, tutor_code });
          toast("Lesson assigned.");
        };
      },0);

      return;
    }

    if (u.role === "learner"){
      const dash = await api("getLearnerDashboard", {});
      setHeader(`Learner Dashboard`, `Track lessons paid, done and remaining.`);
      renderKPIs([
        { label:"Lessons Paid For", value: dash.totals.lessonsBought, sub:`Learner: ${dash.learner_code}` },
        { label:"Lessons Done", value: dash.totals.lessonsDone, sub:"Completed" },
        { label:"Lessons Left", value: dash.totals.lessonsLeft, sub:"Remaining" },
      ]);

      $("sectionTitle").textContent = "Recent Lessons & Purchases";

      const lessonRows = (dash.recentLessons || []).map(l => ([
        `<span class="pill">${l.lesson_id}</span>`,
        l.lesson_date,
        l.tutor_code || "-",
        (String(l.status).toUpperCase()==="DONE")
          ? `<span class="pill green">DONE</span>`
          : `<span class="pill orange">ASSIGNED</span>`,
        (l.notes || "")
      ]));

      const purchaseRows = (dash.purchases || []).map(p => ([
        `<span class="pill">${p.purchase_id}</span>`,
        p.purchase_date,
        p.lessons_bought,
        money(p.amount_paid)
      ]));

      $("sectionBody").innerHTML = `
        <div style="display:grid;grid-template-columns:1fr;gap:12px">
          <div>
            <h2>Lessons</h2>
            ${table(["ID","Date","Tutor","Status","Notes"], lessonRows)}
          </div>
          <div>
            <h2>Purchases</h2>
            ${table(["Purchase","Date","Lessons","Amount"], purchaseRows)}
          </div>
        </div>
      `;
      return;
    }

    if (u.role === "tutor"){
      fillMonthSelect();
      const month = $("monthSelect").value;

      // Backend already provides doneThisMonth list; we use that as the monthly reset.
      const dash = await api("getTutorDashboard", { month });

      const doneCountThisMonth = (dash.doneLessonsThisMonth || []).length;
      const invoice = calcTutorInvoice(doneCountThisMonth);
      const dates = getInvoiceDates(dash.targetMonth);

      setHeader(`Tutor Dashboard`, `Invoice period: ${dash.targetMonth} • Due: ${dates.due} • Paid: ${dates.paid}`);

      renderKPIs([
        { label:"Assigned (Pending)", value: dash.totals.assignedCount, sub:`Tutor: ${dash.tutor_code}` },
        { label:"Lessons Done (This Month)", value: doneCountThisMonth, sub:"Resets monthly" },
        { label:"Invoice Total (This Month)", value: money(invoice.total), sub:"10-pack → 4-pack → singles" },
      ]);

      $("sectionTitle").textContent = "Assigned Lessons (You can mark DONE)";

      const assignedRows = (dash.assignedLessons || []).map(l => ([
        `<span class="pill">${l.lesson_id}</span>`,
        l.lesson_date,
        l.learner_code,
        `${l.minutes || 60}`,
        (l.notes || ""),
        `<button class="btn" style="padding:8px 10px;border-radius:12px;font-size:12px;width:auto" data-done="${l.lesson_id}">Mark DONE</button>`
      ]));

      const doneRows = (dash.doneLessonsThisMonth || []).map(l => ([
        `<span class="pill">${l.lesson_id}</span>`,
        l.lesson_date,
        l.learner_code,
        `<span class="pill green">DONE</span>`,
        (l.notes || "")
      ]));

      const yearRows = (dash.yearSummary || []).map(r => ([
        r.month,
        r.lessonsDone,
        money(r.earnings)
      ]));

      const breakdownRows = (invoice.parts.length ? invoice.parts : [{label:"No lessons completed", qty:0, amount:0}]).map(p => ([
        p.label,
        p.qty,
        money(p.amount)
      ]));

      $("sectionBody").innerHTML = `
        <div style="display:grid;grid-template-columns:1fr;gap:12px">
          <div>
            ${table(["Lesson ID","Date","Learner","Minutes","Notes",""], assignedRows)}
          </div>

          <div class="panel" style="padding:12px;background:#fff;border:1px solid rgba(15,23,42,.10);border-radius:18px;box-shadow:0 12px 24px rgba(15,23,42,.06)">
            <h3 style="margin:0 0 10px;font-size:14px">Invoice Summary (${dash.targetMonth})</h3>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
              <span class="pill orange">Lessons done: ${invoice.n}</span>
              <span class="pill">Invoice due: ${dates.due}</span>
              <span class="pill green">Pay date: ${dates.paid}</span>
              <span class="pill green">Total: ${money(invoice.total)}</span>
            </div>

            <div style="margin: 10px 0 6px; font-size:12px; color: rgba(15,23,42,.72); letter-spacing:.12em; text-transform:uppercase;">
              Package breakdown
            </div>
            ${table(["Type","Qty","Amount"], breakdownRows)}

            <div style="margin-top:10px;font-size:12px;color:rgba(15,23,42,.70);line-height:1.35">
              Payment logic used: <b>10-session package</b> first, then <b>4-session package</b>, then <b>single sessions</b>.
            </div>
          </div>

          <div>
            <h2>Done This Month</h2>
            ${table(["Lesson ID","Date","Learner","Status","Notes"], doneRows)}
          </div>

          <div>
            <h2>Year View</h2>
            ${table(["Month","Lessons Done","Earnings"], yearRows)}
          </div>
        </div>
      `;

      setTimeout(()=>{
        document.querySelectorAll("[data-done]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const lesson_id = btn.getAttribute("data-done");
            btn.disabled = true;
            btn.textContent = "Saving...";
            try{
              await api("tutorMarkLessonDone", { lesson_id });
              toast("Marked DONE.");
              loadRoleHome();
            }catch(e){
              toast(e.message || "Failed");
              btn.disabled = false;
              btn.textContent = "Mark DONE";
            }
          });
        });
      },0);

      return;
    }
  }

  /********************
   * AUTH + INIT
   ********************/
  function saveSession(){
    localStorage.setItem("buddyadmin_session", JSON.stringify(session));
  }
  function loadSession(){
    try{
      const s = JSON.parse(localStorage.getItem("buddyadmin_session") || "null");
      if (s && s.session_code && s.user) session = s;
    }catch(_){}
  }

  async function doLogin(code){
    const r = await api("login", { code });
    if (!r.user) throw new Error("Invalid code");

    session.session_code = r.user.code;
    session.user = r.user;
    saveSession();

    $("who").textContent = r.user.name || r.user.code;
    $("whoMeta").textContent = `${r.user.role.toUpperCase()} • CODE: ${r.user.code}`;
    setSessionUI(true);
    await loadRoleHome();
  }

  function doLogout(){
    session = { session_code:null, user:null };
    localStorage.removeItem("buddyadmin_session");
    setSessionUI(false);
    setHeader("Welcome", "Login to manage lessons, purchases, and invoices.");
  }

  $("loginBtn").onclick = async () => {
    try{
      const code = $("codeInput").value.trim();
      if(!code) return toast("Enter your unique code.");
      await doLogin(code);
      toast("Logged in.");
    }catch(e){
      toast(e.message || "Login failed");
    }
  };

  $("logoutBtn").onclick = () => {
    doLogout();
    toast("Logged out.");
  };

  $("monthSelect").addEventListener("change", () => loadRoleHome());

  (async function init(){
    loadSession();
    if (session.user){
      $("who").textContent = session.user.name || session.user.code;
      $("whoMeta").textContent = `${session.user.role.toUpperCase()} • CODE: ${session.user.code}`;
      setSessionUI(true);
      try{
        await loadRoleHome();
      }catch(e){
        toast("Session expired. Please login again.");
        doLogout();
      }
    } else {
      setSessionUI(false);
    }
  })();
</script>
</body>
</html>
